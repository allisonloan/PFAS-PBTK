#Load packages
```{r}
library(httk)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(purrr)
library(readr)
library(forcats)
library(viridis)
library(Rtsne)
```

#Load Feces
```{r}
#Imported in mg/kg
feces_28  <- read.csv("C:invivo-pfas-immunotox/R input 28d/Liver PFAS values phase 1 28d.csv")
doses <- c("Naive", "Vehicle", " PFOA 1.5",  " PFOS 1.5")
pfas_cols <- c(
  "PFOA", "PFOS", "PFBA", "PFPeA", "PFHxA", "PFHpA", "PFNA", "PFDA", "PFUdA", "PFDoA", "PFTrDA", "PFTeDA",
  "PFBS", "PFPeS", "PFHxS", "PFHpS", "PFNS", "PFDS",
  "X4_2.FTS", "X6_2_FTS", "X8_2.FTS", "N.MeFOSAA", "N.EtFOSAA", "FOSA"
)
mdls_naive_vehicle <- c(
  PFOA = 0.184, PFOS = 0.285, PFBA = 0.139, PFPeA = 0.164, PFHxA = 0.138,
  PFHpA = 0.107, PFNA = 0.153, PFDA = 0.114, PFUdA = 0.115, PFDoA = 0.087,
  PFTrDA = 0.104, PFTeDA = 0.145, PFBS = 0.526, PFPeS = 0.297, PFHxS = 0.758,
  PFHpS = 0.251, PFNS = 0.232, PFDS = 0.202, `X4_2.FTS` = 0.211, `X6_2_FTS` = 0.306,
  `X8_2.FTS` = 0.231
)

mdls_dose_1_15 <-  c(
  PFOA = 0.781, PFOS = 1.148, PFBA = 0.392, PFPeA = 0.426, PFHxA = 0.573,
  PFHpA = 0.233, PFNA = 0.766, PFDA = 1.030, PFUdA = 0.372, PFDoA = 0.575,
  PFTrDA = 0.524, PFTeDA = 0.562, PFBS = 0.748, PFPeS = 1.263, PFHxS = 0.776,
  PFHpS = 0.932, PFNS = 0.822, PFDS = 1.309, `X4_2.FTS` = 0.369, `X6_2_FTS` = 1.381,
  `X8_2.FTS` = 1.354, N.MeFOSAA = 1.455, N.EtFOSAA = 0.854, FOSA = 0.513
)

mdls_df <- bind_rows(
  tibble(Group = "Naive", !!!mdls_naive_vehicle),
  tibble(Group = "Vehicle", !!!mdls_naive_vehicle),
  tibble(Group = "1.5", !!!mdls_dose_1_15)
) %>%
  pivot_longer(
    -Group,
    names_to = "PFAS",
    values_to = "MDL"
  )


pfas_cols <- mdls_df$PFAS %>% unique()
feces_28[pfas_cols] <- lapply(feces_28[pfas_cols], as.character)

for (pfas_name in unique(mdls_df$PFAS)) {
  if (pfas_name %in% colnames(feces_28)) {
    for (dose_level in unique(mdls_df$Group)) {
      mdl_val <- mdls_df %>%
        filter(PFAS == pfas_name, Group == dose_level) %>%
        pull(MDL)

      if (length(mdl_val) == 1 && !is.na(mdl_val)) {
        dose_match <- trimws(gsub("^.*\\s", "", feces_28$Group))
        idx <- which(dose_match == dose_level & feces_28[[pfas_name]] == "<MDL")

        if (length(idx) > 0) {
          data_conc[idx, pfas_name] <- mdl_val / 2
        }
      }
    }
  }
}

pfas_cols <- unique(mdls_df$PFAS)
feces_28[pfas_cols] <- lapply(feces_28[pfas_cols], as.numeric)
pfas_cols <- unique(mdls_df$PFAS)
feces_28[feces_28$Group %in% c("Naive", "Vehicle"), pfas_cols] <-
  feces_28[feces_28$Group %in% c("Naive", "Vehicle"), pfas_cols] / 1000

data_conc_subset <- feces_28 %>%
  dplyr::select(Mouse.ID, Sex, Group, all_of(pfas_cols))

write.csv(feces_28, file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Desktop/PFAS PBTK/Feces_PFAS_values_fixed_28d.csv", row.names = FALSE)

feces_56  <- read.csv("/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/invivo-pfas-immunotox/R input 56d/Liver_PFAS_values_fixed_56d.csv")
doses <- c("Naive", "Vehicle", "PFOA 0.166", "PFOA 0.5", "PFOA 1", " PFOA 1.5", "PFOS 0.166", "PFOS 0.5", "PFOS 1", " PFOS 1.5")
pfas_cols <- c(
  "PFOA", "PFOS", "PFBA", "PFPeA", "PFHxA", "PFHpA", "PFNA", "PFDA", "PFUdA", "PFDoA", "PFTrDA", "PFTeDA",
  "PFBS", "PFPeS", "PFHxS", "PFHpS", "PFNS", "PFDS",
  "X4_2.FTS", "X6_2_FTS", "X8_2.FTS", "N.MeFOSAA", "N.EtFOSAA", "FOSA"
)

mdls_naive_vehicle <- c(
  PFOA = 0.184, PFOS = 0.285, PFBA = 0.139, PFPeA = 0.164, PFHxA = 0.138,
  PFHpA = 0.107, PFNA = 0.153, PFDA = 0.114, PFUdA = 0.115, PFDoA = 0.087,
  PFTrDA = 0.104, PFTeDA = 0.145, PFBS = 0.526, PFPeS = 0.297, PFHxS = 0.758,
  PFHpS = 0.251, PFNS = 0.232, PFDS = 0.202, `X4_2.FTS` = 0.211, `X6_2_FTS` = 0.306,
  `X8_2.FTS` = 0.231
)

mdls_dose_0166_05 <- c(
  PFOA = 0.156, PFOS = 0.230, PFBA = 0.078, PFPeA = 0.085, PFHxA = 0.115,
  PFHpA = 0.047, PFNA = 0.153, PFDA = 0.206, PFUdA = 0.074, PFDoA = 0.115,
  PFTrDA = 0.105, PFTeDA = 0.112, PFBS = 0.150, PFPeS = 0.253, PFHxS = 0.155,
  PFHpS = 0.186, PFNS = 0.164, PFDS = 0.262, `X4_2.FTS` = 0.074, `X6_2_FTS` = 0.276,
  `X8_2.FTS` = 0.271, N.MeFOSAA = 0.291, N.EtFOSAA = 0.171, FOSA = 0.103
)

mdls_dose_1_15 <-  c(
  PFOA = 0.781, PFOS = 1.148, PFBA = 0.392, PFPeA = 0.426, PFHxA = 0.573,
  PFHpA = 0.233, PFNA = 0.766, PFDA = 1.030, PFUdA = 0.372, PFDoA = 0.575,
  PFTrDA = 0.524, PFTeDA = 0.562, PFBS = 0.748, PFPeS = 1.263, PFHxS = 0.776,
  PFHpS = 0.932, PFNS = 0.822, PFDS = 1.309, `X4_2.FTS` = 0.369, `X6_2_FTS` = 1.381,
  `X8_2.FTS` = 1.354, N.MeFOSAA = 1.455, N.EtFOSAA = 0.854, FOSA = 0.513
)

mdls_df <- bind_rows(
  tibble(Group = "Naive", !!!mdls_naive_vehicle),
  tibble(Group = "Vehicle", !!!mdls_naive_vehicle),
  tibble(Group = "0.166", !!!mdls_dose_0166_05),
  tibble(Group = "0.5", !!!mdls_dose_0166_05),
  tibble(Group = "1", !!!mdls_dose_1_15),
  tibble(Group = "1.5", !!!mdls_dose_1_15)
) %>%
  pivot_longer(
    -Group,
    names_to = "PFAS",
    values_to = "MDL"
  )

pfas_cols <- mdls_df$PFAS %>% unique()
feces_56[pfas_cols] <- lapply(feces_56[pfas_cols], as.character)

for (pfas_name in unique(mdls_df$PFAS)) {
  if (pfas_name %in% colnames(feces_56)) {
    for (dose_level in unique(mdls_df$Group)) {
      mdl_val <- mdls_df %>%
        filter(PFAS == pfas_name, Group == dose_level) %>%
        pull(MDL)

      if (length(mdl_val) == 1 && !is.na(mdl_val)) {
        dose_match <- trimws(gsub("^.*\\s", "", feces_56$Group))
        idx <- which(dose_match == dose_level & feces_56[[pfas_name]] == "<MDL")

        if (length(idx) > 0) {
          data_conc[idx, pfas_name] <- mdl_val / 2
        }
      }
    }
  }
}


pfas_cols <- unique(mdls_df$PFAS)
feces_56[pfas_cols] <- lapply(feces_56[pfas_cols], as.numeric)
pfas_cols <- unique(mdls_df$PFAS)

feces_56[feces_56$Group %in% c("Naive", "Vehicle"), pfas_cols] <-
  feces_56[feces_56$Group %in% c("Naive", "Vehicle"), pfas_cols] / 1000

data_conc_subset <- feces_56 %>%
  dplyr::select(Mouse.ID, Sex, Group, all_of(pfas_cols))
write.csv(feces_56, file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Desktop/PFAS PBTK/Feces_PFAS_values_fixed_56d.csv", row.names = FALSE)
```

##Plotting Feces Data
```{r}
  feces_56 <- read.csv(file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents//invivo-pfas-immunotox/R input 56d/fake feces_56.csv" )
other_pfas <- setdiff(pfas_cols, c("PFOS", "PFOA"))
plasma_colors <- viridis(length(other_pfas), option = "plasma")
names(plasma_colors) <- other_pfas

custom_colors <- c(
  "PFOS" = "red",   
  "PFOA" = "blue",   
  plasma_colors          
)

group_levels <- c(
  "Naive", "Vehicle",
  paste("PFOS", c("0.166", "0.5", "1", "1.5")),
  paste("PFOA", c("0.166", "0.5", "1", "1.5"))
)

data_combined_long <- feces_56 %>%
  pivot_longer(
    cols = all_of(pfas_cols),
    names_to = "PFAS_name",
    values_to = "PFAS_conc"
  ) %>%
  filter(!is.na(PFAS_conc)) %>%
  mutate(
    PFAS_conc = as.numeric(PFAS_conc),
    group = factor(Group, levels = group_levels),
    PFAS_name = factor(PFAS_name, levels = names(custom_colors)) 
  )

average_pfas <- feces_56 %>%
  group_by(Group) %>%
  summarise(
    Mean_PFOS = format(mean(PFOS, na.rm = TRUE), scientific = FALSE),
    Mean_PFOA = format(mean(PFOA, na.rm = TRUE), scientific = FALSE),
    .groups = "drop"
  )

print(average_pfas)
# Plot
p <-ggplot(data_combined_long, aes(x = group, y = PFAS_conc, color =  PFAS_name, shape= Sex)) +
    geom_jitter(alpha = 0.7, size = 2.2, width = 0.2, height = 0) +
  scale_color_manual(values = custom_colors) +
  labs(
    x = "Group",
    y = "Feces PFAS concentration 56 (mg/kg)",
    color = "PFAS"
  ) +
  coord_cartesian(ylim = c(0, 300)) +  
  theme_minimal() +
  theme(
        text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "none",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank()
  )
print(p)
ggsave(filename = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Desktop/PFAS PBTK/feces_56_conc.png", plot = p, width = 12.5, height = 5, dpi = 300,bg = "white")
replicate_summary <- feces_56%>%
  group_by(Group) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))


feces_28 <- read.csv(file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents//invivo-pfas-immunotox/R input 28d/Liver PFAS values phase 1 28d.csv")

other_pfas <- setdiff(pfas_cols, c("PFOS", "PFOA"))
plasma_colors <- viridis(length(other_pfas), option = "plasma")
names(plasma_colors) <- other_pfas

custom_colors <- c(
  "PFOS" = "red",   
  "PFOA" = "blue",    
  plasma_colors          
)

group_levels <- c(
  "Naive", "Vehicle",
  paste("PFOS", c("0.166", "0.5", "1", "1.5")),
  paste("PFOA", c("0.166", "0.5", "1", "1.5"))
)

data_combined_long <- feces_28 %>%
  pivot_longer(
    cols = all_of(pfas_cols),
    names_to = "PFAS_name",
    values_to = "PFAS_conc"
  ) %>%
  filter(!is.na(PFAS_conc)) %>%
  mutate(
    PFAS_conc = as.numeric(PFAS_conc),
    group = factor(Group, levels = group_levels),
    PFAS_name = factor(PFAS_name, levels = names(custom_colors)) 
  )
average_pfas <- feces_28 %>%
  group_by(Group) %>%
  summarise(
    Mean_PFOS = format(mean(PFOS, na.rm = TRUE), scientific = FALSE),
    Mean_PFOA = format(mean(PFOA, na.rm = TRUE), scientific = FALSE),
    .groups = "drop"
  )

print(average_pfas)
p <-ggplot(data_combined_long, aes(x = group, y = PFAS_conc, color =  PFAS_name, shape= Sex)) +
    geom_jitter(alpha = 0.7, size = 2.2, width = 0.2, height = 0) +
  scale_color_manual(values = custom_colors) +
  labs(
    x = "Group",
    y = "Liver PFAS concentration (mg/kg)",
    color = "PFAS"
  ) +
   coord_cartesian(ylim = c(0, 800)) +  
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )
print(p)
ggsave(filename = "../invivo-pfas-immunotox/R input 28d/plots/Feces_conc_28d.png", plot = p, width = 5, height = 5, dpi = 300,bg = "white")
replicate_summary <- feces_28%>%
  group_by(Group) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))

```

##Correlation between liver and feces
##Correlation between plasma and feces

#Load kidney
```{r}
#Imported in mg/kg
kidney_28  <- read.csv("/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/invivo-pfas-immunotox/R input 28d/Liver_PFAS_values_fixed_28d.csv")
doses <- c("Naive", "Vehicle", " PFOA 1.5",  " PFOS 1.5")
pfas_cols <- c(
  "PFOA", "PFOS", "PFBA", "PFPeA", "PFHxA", "PFHpA", "PFNA", "PFDA", "PFUdA", "PFDoA", "PFTrDA", "PFTeDA",
  "PFBS", "PFPeS", "PFHxS", "PFHpS", "PFNS", "PFDS",
  "X4_2.FTS", "X6_2_FTS", "X8_2.FTS", "N.MeFOSAA", "N.EtFOSAA", "FOSA"
)
mdls_naive_vehicle <- c(
  PFOA = 0.184, PFOS = 0.285, PFBA = 0.139, PFPeA = 0.164, PFHxA = 0.138,
  PFHpA = 0.107, PFNA = 0.153, PFDA = 0.114, PFUdA = 0.115, PFDoA = 0.087,
  PFTrDA = 0.104, PFTeDA = 0.145, PFBS = 0.526, PFPeS = 0.297, PFHxS = 0.758,
  PFHpS = 0.251, PFNS = 0.232, PFDS = 0.202, `X4_2.FTS` = 0.211, `X6_2_FTS` = 0.306,
  `X8_2.FTS` = 0.231
)

mdls_dose_1_15 <-  c(
  PFOA = 0.781, PFOS = 1.148, PFBA = 0.392, PFPeA = 0.426, PFHxA = 0.573,
  PFHpA = 0.233, PFNA = 0.766, PFDA = 1.030, PFUdA = 0.372, PFDoA = 0.575,
  PFTrDA = 0.524, PFTeDA = 0.562, PFBS = 0.748, PFPeS = 1.263, PFHxS = 0.776,
  PFHpS = 0.932, PFNS = 0.822, PFDS = 1.309, `X4_2.FTS` = 0.369, `X6_2_FTS` = 1.381,
  `X8_2.FTS` = 1.354, N.MeFOSAA = 1.455, N.EtFOSAA = 0.854, FOSA = 0.513
)

mdls_df <- bind_rows(
  tibble(Group = "Naive", !!!mdls_naive_vehicle),
  tibble(Group = "Vehicle", !!!mdls_naive_vehicle),
  tibble(Group = "1.5", !!!mdls_dose_1_15)
) %>%
  pivot_longer(
    -Group,
    names_to = "PFAS",
    values_to = "MDL"
  )


pfas_cols <- mdls_df$PFAS %>% unique()
kidney_28[pfas_cols] <- lapply(kidney_28[pfas_cols], as.character)

for (pfas_name in unique(mdls_df$PFAS)) {
  if (pfas_name %in% colnames(kidney_28)) {
    for (dose_level in unique(mdls_df$Group)) {
      mdl_val <- mdls_df %>%
        filter(PFAS == pfas_name, Group == dose_level) %>%
        pull(MDL)

      if (length(mdl_val) == 1 && !is.na(mdl_val)) {
        dose_match <- trimws(gsub("^.*\\s", "", kidney_28$Group))
        idx <- which(dose_match == dose_level & kidney_28[[pfas_name]] == "<MDL")

        if (length(idx) > 0) {
          data_conc[idx, pfas_name] <- mdl_val / 2
        }
      }
    }
  }
}

pfas_cols <- unique(mdls_df$PFAS)
kidney_28[pfas_cols] <- lapply(kidney_28[pfas_cols], as.numeric)
pfas_cols <- unique(mdls_df$PFAS)
kidney_28[kidney_28$Group %in% c("Naive", "Vehicle"), pfas_cols] <-
  kidney_28[kidney_28$Group %in% c("Naive", "Vehicle"), pfas_cols] / 1000

data_conc_subset <- kidney_28 %>%
  dplyr::select(Mouse.ID, Sex, Group, all_of(pfas_cols))

write.csv(kidney_28, file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Desktop/PFAS PBTK/Kidney_PFAS_values_fixed_28d.csv", row.names = FALSE)

kidney_56  <- read.csv("/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/invivo-pfas-immunotox/R input 56d/Liver_PFAS_values_fixed_56d.csv")

doses <- c("Naive", "Vehicle", "PFOA 0.166", "PFOA 0.5", "PFOA 1", " PFOA 1.5", "PFOS 0.166", "PFOS 0.5", "PFOS 1", " PFOS 1.5")
pfas_cols <- c(
  "PFOA", "PFOS", "PFBA", "PFPeA", "PFHxA", "PFHpA", "PFNA", "PFDA", "PFUdA", "PFDoA", "PFTrDA", "PFTeDA",
  "PFBS", "PFPeS", "PFHxS", "PFHpS", "PFNS", "PFDS",
  "X4_2.FTS", "X6_2_FTS", "X8_2.FTS", "N.MeFOSAA", "N.EtFOSAA", "FOSA"
)

mdls_naive_vehicle <- c(
  PFOA = 0.184, PFOS = 0.285, PFBA = 0.139, PFPeA = 0.164, PFHxA = 0.138,
  PFHpA = 0.107, PFNA = 0.153, PFDA = 0.114, PFUdA = 0.115, PFDoA = 0.087,
  PFTrDA = 0.104, PFTeDA = 0.145, PFBS = 0.526, PFPeS = 0.297, PFHxS = 0.758,
  PFHpS = 0.251, PFNS = 0.232, PFDS = 0.202, `X4_2.FTS` = 0.211, `X6_2_FTS` = 0.306,
  `X8_2.FTS` = 0.231
)

mdls_dose_0166_05 <- c(
  PFOA = 0.156, PFOS = 0.230, PFBA = 0.078, PFPeA = 0.085, PFHxA = 0.115,
  PFHpA = 0.047, PFNA = 0.153, PFDA = 0.206, PFUdA = 0.074, PFDoA = 0.115,
  PFTrDA = 0.105, PFTeDA = 0.112, PFBS = 0.150, PFPeS = 0.253, PFHxS = 0.155,
  PFHpS = 0.186, PFNS = 0.164, PFDS = 0.262, `X4_2.FTS` = 0.074, `X6_2_FTS` = 0.276,
  `X8_2.FTS` = 0.271, N.MeFOSAA = 0.291, N.EtFOSAA = 0.171, FOSA = 0.103
)

mdls_dose_1_15 <-  c(
  PFOA = 0.781, PFOS = 1.148, PFBA = 0.392, PFPeA = 0.426, PFHxA = 0.573,
  PFHpA = 0.233, PFNA = 0.766, PFDA = 1.030, PFUdA = 0.372, PFDoA = 0.575,
  PFTrDA = 0.524, PFTeDA = 0.562, PFBS = 0.748, PFPeS = 1.263, PFHxS = 0.776,
  PFHpS = 0.932, PFNS = 0.822, PFDS = 1.309, `X4_2.FTS` = 0.369, `X6_2_FTS` = 1.381,
  `X8_2.FTS` = 1.354, N.MeFOSAA = 1.455, N.EtFOSAA = 0.854, FOSA = 0.513
)

mdls_df <- bind_rows(
  tibble(Group = "Naive", !!!mdls_naive_vehicle),
  tibble(Group = "Vehicle", !!!mdls_naive_vehicle),
  tibble(Group = "0.166", !!!mdls_dose_0166_05),
  tibble(Group = "0.5", !!!mdls_dose_0166_05),
  tibble(Group = "1", !!!mdls_dose_1_15),
  tibble(Group = "1.5", !!!mdls_dose_1_15)
) %>%
  pivot_longer(
    -Group,
    names_to = "PFAS",
    values_to = "MDL"
  )

pfas_cols <- mdls_df$PFAS %>% unique()
kidney_56[pfas_cols] <- lapply(kidney_56[pfas_cols], as.character)

for (pfas_name in unique(mdls_df$PFAS)) {
  if (pfas_name %in% colnames(kidney_56)) {
    for (dose_level in unique(mdls_df$Group)) {
      mdl_val <- mdls_df %>%
        filter(PFAS == pfas_name, Group == dose_level) %>%
        pull(MDL)

      if (length(mdl_val) == 1 && !is.na(mdl_val)) {
        dose_match <- trimws(gsub("^.*\\s", "", kidney_56$Group))
        idx <- which(dose_match == dose_level & kidney_56[[pfas_name]] == "<MDL")

        if (length(idx) > 0) {
          data_conc[idx, pfas_name] <- mdl_val / 2
        }
      }
    }
  }
}


pfas_cols <- unique(mdls_df$PFAS)
kidney_56[pfas_cols] <- lapply(kidney_56[pfas_cols], as.numeric)
pfas_cols <- unique(mdls_df$PFAS)

kidney_56[kidney_56$Group %in% c("Naive", "Vehicle"), pfas_cols] <-
  kidney_56[kidney_56$Group %in% c("Naive", "Vehicle"), pfas_cols] / 1000

data_conc_subset <- kidney_56 %>%
  dplyr::select(Mouse.ID, Sex, Group, all_of(pfas_cols))
write.csv(kidney_56, file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Desktop/PFAS PBTK/Kidney_PFAS_values_fixed_56d.csv", row.names = FALSE)

```

##Plotting Kidney
```{r}
kidney_56 <- read.csv(file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Desktop/PFAS PBTK/Kidney_PFAS_values_fixed_56d.csv")
other_pfas <- setdiff(pfas_cols, c("PFOS", "PFOA"))
plasma_colors <- viridis(length(other_pfas), option = "plasma")
names(plasma_colors) <- other_pfas

custom_colors <- c(
  "PFOS" = "red",   
  "PFOA" = "blue",   
  plasma_colors          
)

group_levels <- c(
  "Naive", "Vehicle",
  paste("PFOS", c("0.166", "0.5", "1", "1.5")),
  paste("PFOA", c("0.166", "0.5", "1", "1.5"))
)

data_combined_long <- kidney_56 %>%
  pivot_longer(
    cols = all_of(pfas_cols),
    names_to = "PFAS_name",
    values_to = "PFAS_conc"
  ) %>%
  filter(!is.na(PFAS_conc)) %>%
  mutate(
    PFAS_conc = as.numeric(PFAS_conc),
    group = factor(Group, levels = group_levels),
    PFAS_name = factor(PFAS_name, levels = names(custom_colors)) 
  )

average_pfas <- kidney_56 %>%
  group_by(Group) %>%
  summarise(
    Mean_PFOS = format(mean(PFOS, na.rm = TRUE), scientific = FALSE),
    Mean_PFOA = format(mean(PFOA, na.rm = TRUE), scientific = FALSE),
    .groups = "drop"
  )

print(average_pfas)
# Plot
p <-ggplot(data_combined_long, aes(x = group, y = PFAS_conc, color =  PFAS_name, shape= Sex)) +
    geom_jitter(alpha = 0.7, size = 2.2, width = 0.2, height = 0) +
  scale_color_manual(values = custom_colors) +
  labs(
    x = "Group",
    y = "Feces PFAS concentration 56 (mg/kg)",
    color = "PFAS"
  ) +
  coord_cartesian(ylim = c(0, 300)) +  
  theme_minimal() +
  theme(
        text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "none",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank()
  )
print(p)
ggsave(filename = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Desktop/PFAS PBTK/kidney_56_conc.png", plot = p, width = 12.5, height = 5, dpi = 300,bg = "white")
replicate_summary <- kidney_56%>%
  group_by(Group) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))


kidney_28 <- read.csv(file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Desktop/PFAS PBTK/Kidney_PFAS_values_fixed_28d.csv")

other_pfas <- setdiff(pfas_cols, c("PFOS", "PFOA"))
plasma_colors <- viridis(length(other_pfas), option = "plasma")
names(plasma_colors) <- other_pfas

custom_colors <- c(
  "PFOS" = "red",   
  "PFOA" = "blue",    
  plasma_colors          
)

group_levels <- c(
  "Naive", "Vehicle",
  paste("PFOS", c("0.166", "0.5", "1", "1.5")),
  paste("PFOA", c("0.166", "0.5", "1", "1.5"))
)

data_combined_long <- kidney_28 %>%
  pivot_longer(
    cols = all_of(pfas_cols),
    names_to = "PFAS_name",
    values_to = "PFAS_conc"
  ) %>%
  filter(!is.na(PFAS_conc)) %>%
  mutate(
    PFAS_conc = as.numeric(PFAS_conc),
    group = factor(Group, levels = group_levels),
    PFAS_name = factor(PFAS_name, levels = names(custom_colors)) 
  )
average_pfas <- kidney_28 %>%
  group_by(Group) %>%
  summarise(
    Mean_PFOS = format(mean(PFOS, na.rm = TRUE), scientific = FALSE),
    Mean_PFOA = format(mean(PFOA, na.rm = TRUE), scientific = FALSE),
    .groups = "drop"
  )

print(average_pfas)
p <-ggplot(data_combined_long, aes(x = group, y = PFAS_conc, color =  PFAS_name, shape= Sex)) +
    geom_jitter(alpha = 0.7, size = 2.2, width = 0.2, height = 0) +
  scale_color_manual(values = custom_colors) +
  labs(
    x = "Group",
    y = "Liver PFAS concentration (mg/kg)",
    color = "PFAS"
  ) +
   coord_cartesian(ylim = c(0, 800)) +  
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )
print(p)
ggsave(filename = "../invivo-pfas-immunotox/R input 28d/plots/kidney_conc_28d.png", plot = p, width = 5, height = 5, dpi = 300,bg = "white")
replicate_summary <- kidney_28%>%
  group_by(Group) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))

```

##Correlation between plasma and kidney
##Correlation between liver and kidney

#Load the other data
```{r}
mw_pfos <- 538.12  # g/mol for PFOS
mw_pfoa <- 414.07  # g/mol for PFOA

#Imported in mg/L
plasma_28 <- read.csv("/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/invivo-pfas-immunotox/R input 28d/plasma_PFAS_values_fixed_28d.csv")
plasma_56 <- read.csv("/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/invivo-pfas-immunotox/R input 56d/Plasma_PFAS_values_fixed_56d.csv")
#Imported in mg/kg
liver_28  <- read.csv("/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/invivo-pfas-immunotox/R input 28d/Liver_PFAS_values_fixed_28d.csv")
liver_56  <- read.csv("/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/invivo-pfas-immunotox/R input 56d/Liver_PFAS_values_fixed_56d.csv")


process_pfas_file <- function(df, tissue, timepoint) {
  df <- df %>% filter(Group != "Naive")
  df_vehicle <- df %>%
    filter(Group == "Vehicle") %>%
    mutate(
      PFAS_type = "PFOA",
      PFAS_conc = PFOA,
      Tissue = tissue,
      Time = timepoint
    )
  df_vehicle_dup <- df_vehicle %>%
    mutate(
      PFAS_type = "PFOS",
      PFAS_conc = PFOS
    )
  df_vehicles_all <- bind_rows(df_vehicle, df_vehicle_dup)
  df_exposed <- df %>%
    filter(Group != "Vehicle") %>%
    mutate(
      PFAS_type = case_when(
        str_starts(Group, "PFOS") ~ "PFOS",
        str_starts(Group, "PFOA") ~ "PFOA",
        TRUE ~ NA_character_
      ),
      PFAS_conc = case_when(
        PFAS_type == "PFOS" ~ PFOS,
        PFAS_type == "PFOA" ~ PFOA,
        TRUE ~ NA_real_
      ),
      Tissue = tissue,
      Time = timepoint
    )
  df_final <- bind_rows(df_vehicles_all, df_exposed) %>%
    dplyr::select(Mouse.ID, Group, PFAS_type, PFAS_conc, Tissue, Time)
  return(df_final)
}

plasma_28_clean <- process_pfas_file(plasma_28, tissue = "Plasma", timepoint = 28)
plasma_56_clean <- process_pfas_file(plasma_56, tissue = "Plasma", timepoint = 56)
liver_28_clean  <- process_pfas_file(liver_28,  tissue = "Liver",  timepoint = 28)
liver_56_clean  <- process_pfas_file(liver_56,  tissue = "Liver",  timepoint = 56)

pfas_obs_all <- bind_rows(plasma_28_clean, plasma_56_clean, liver_28_clean, liver_56_clean)


pfas_obs_all <- pfas_obs_all %>%
  mutate(
    Dose = case_when(
      Group == "Vehicle" ~ 0,
      TRUE ~ as.numeric(str_extract(Group, "\\d+\\.?\\d*"))
    ),
    # Assign molecular weight based on PFAS type
    mw = case_when(
      PFAS_type == "PFOA" ~ mw_pfoa,
      PFAS_type == "PFOS" ~ mw_pfos,
      TRUE ~ NA_real_
    ),
    # Units: Plasma = mg/L, Other tissues = mg/kg (assume 1 mg/kg ≈ 1 mg/L)
    uM = PFAS_conc / mw * 1000,  # convert mg/L (or mg/kg) → µM
    # Plasma-specific conversions
    mg_L = ifelse(Tissue == "Plasma", PFAS_conc, NA_real_),
    ng_L = ifelse(Tissue == "Plasma", PFAS_conc * 1e6, NA_real_),
    # Non-plasma tissues keep mg/kg
    mg_kg = ifelse(Tissue != "Plasma", PFAS_conc, NA_real_)
  ) %>%
  select(-mw)  # optional cleanup

```

#Validate httk
##PFOS Plasma pfas1comp httk 2.7.2.
```{r}
pfos_obs <- pfas_obs_all %>%
  filter(PFAS_type == "PFOS") %>%
  mutate(uM = as.numeric(trimws(uM)))

plasma_obs <- pfos_obs %>%
  filter(Tissue == "Plasma") %>%
  select(Dose, Time, uM, Mouse.ID)

dose_vec <- unique(pfos_obs$Dose)
time_vec <- unique(pfos_obs$Time)
sim_days <- max(time_vec) 

# Run PFAS model
pred_1comp <- map_df(dose_vec, function(dose) {
  pars <- parameterize_pfas1comp(
    chem.cas = "1763-23-1",
    species = "Mouse",
    dosingadj = "Oral",
    suppress.messages = TRUE
  )
  
  sim <- solve_1comp(
    parameters    = pars,
    daily.dose    = dose,
    doses.per.day = 1,
    days          = sim_days,
    output.units  = "uM"
  )
  
  # Check this!! (convert to plasma)
  rb2p <- pars$Rblood2plasma %||% 1  # equivalent to "if null then 1"
  c_plasma <- if ("Cplasma" %in% colnames(sim))
    sim[, "Cplasma"]
  else
    sim[, "Ccompartment"] / rb2p
  
  pred <- approx(
    x = sim[, "time"],
    y = c_plasma,
    xout = time_vec,
    rule = 2
  )

  tibble(
    Dose = dose,
    Time = pred$x,
    Predicted_Conc_uM = pred$y,
    Model = "PFAS-1comp"
  )
})


# Ensure numeric 
pred_1comp <- pred_1comp %>%
  mutate(Predicted_Conc_uM = as.numeric(Predicted_Conc_uM))


# Plot
ggplot() +
  geom_point(
    data = pred_1comp,
    aes(x = Dose, y = Predicted_Conc_uM, color = factor(Dose)),
    shape = 17, size = 3.2, alpha = 0.9
  ) +
  geom_point(
    data = plasma_obs,
    aes(x = Dose, y = uM, color = factor(Dose)),
    shape = 16, size = 2.4, alpha = 0.75
  ) +
  facet_wrap(~ Time, scales = "free_y", nrow = 1) +
  scale_y_log10() +
  labs(
    title = "PFOS — Plasma: PFAS 1-comp vs Observed",
    x = "Dose (mg/kg/day)", 
    y = "Plasma (µM, log10)", 
    color = "Dose",
    caption = "Triangles: PFAS 1-comp; Circles: Observed"
  ) +
  theme_minimal(base_size = 12)
```
##PFOA Plasma pfas1comp httk 2.7.2.
```{r}
pfoa_obs <- pfas_obs_all %>%
  filter(PFAS_type == "PFOA") %>%
  mutate(uM = as.numeric(trimws(uM)))

plasma_obs <- pfoa_obs %>%
  filter(Tissue == "Plasma") %>%
  select(Dose, Time, uM, Mouse.ID)

dose_vec <- unique(pfoa_obs$Dose)
time_vec <- unique(pfoa_obs$Time)
sim_days <- max(time_vec) 

# Run PFAS model
pred_1comp <- map_df(dose_vec, function(dose) {
  pars <- parameterize_pfas1comp(
    chem.cas = "335-67-1",
    species = "Mouse",
    dosingadj = "Oral",
    suppress.messages = TRUE
  )
  
  sim <- solve_1comp(
    parameters    = pars,
    daily.dose    = dose,
    doses.per.day = 1,
    days          = sim_days,
    output.units  = "uM"
  )
  
  # Check this!! (convert to plasma)
  rb2p <- pars$Rblood2plasma %||% 1  # equivalent to "if null then 1"
  c_plasma <- if ("Cplasma" %in% colnames(sim))
    sim[, "Cplasma"]
  else
    sim[, "Ccompartment"] / rb2p
  
  pred <- approx(
    x = sim[, "time"],
    y = c_plasma,
    xout = time_vec,
    rule = 2
  )

  tibble(
    Dose = dose,
    Time = pred$x,
    Predicted_Conc_uM = pred$y,
    Model = "PFAS-1comp"
  )
})

# Ensure numeric 
pred_1comp <- pred_1comp %>%
  mutate(Predicted_Conc_uM = as.numeric(Predicted_Conc_uM))


# Plot
ggplot() +
  geom_point(
    data = pred_1comp,
    aes(x = Dose, y = Predicted_Conc_uM, color = factor(Dose)),
    shape = 17, size = 3.2, alpha = 0.9
  ) +
  geom_point(
    data = plasma_obs,
    aes(x = Dose, y = uM, color = factor(Dose)),
    shape = 16, size = 2.4, alpha = 0.75
  ) +
  facet_wrap(~ Time, scales = "free_y", nrow = 1) +
  scale_y_log10() +
  labs(
    title = "PFOA — Plasma: PFAS 1-comp vs Observed",
    x = "Dose (mg/kg/day)", 
    y = "Plasma (µM, log10)", 
    color = "Dose",
    caption = "Triangles: PFAS 1-comp; Circles: Observed"
  ) +
  theme_minimal(base_size = 12)
```
###PFOS Plasma PBTK solve_pbtk (class.exclude =F)
```{r}
pfos_obs <- pfas_obs_all %>%
  filter(PFAS_type == "PFOS")

dose_vec <- unique(pfos_obs$Dose)
time_vec <- unique(pfos_obs$Time)
tissues_all <- c("Plasma", "Liver", "Kidney", "Lung", "Fat", "Gut", "Bone", "Skin", "Muscle")

# Function to map tissue names to PBTK model column names
tissue_to_col <- function(tissue) {
  switch(tissue,
         Plasma = "Cplasma",
         Liver = "Cliver",
         Kidney = "Ckidney",
         Lung = "Clung",
         Fat = "Cfat",
         Gut = "Cgut",
         Bone = "Cbone",
         Skin = "Cskin",
         Muscle = "Cmuscle",
         stop(paste("Tissue not supported:", tissue)))
}

# Run model and get predictions
predictions <- map_df(dose_vec, function(dose) {
  out <- solve_pbtk(chem.cas =  "1763-23-1", 
                    days = max(time_vec), 
                    class.exclude = FALSE,
                    doses.per.day = 1,
                    daily.dose = dose,
                    output.units = "uM")

  map_df(tissues_all, function(tiss) {
    col_name <- tissue_to_col(tiss)
    
    if (!(col_name %in% colnames(out))) return(NULL)
    
    pred <- approx(x = out[, "time"], y = out[, col_name], xout = time_vec, rule = 2)
    
    data.frame(
      Dose = dose,
      Time = pred$x,
      Tissue = tiss,
      Predicted_Conc_uM = pred$y
    )
  })
})

# Join model predictions with observed data 
comparison <- pfos_obs %>%
  left_join(predictions, by = c("Dose", "Time", "Tissue"))

# Separate predicted-only data for tissues without observations
model_only <- predictions %>%
  anti_join(pfos_obs, by = c("Dose", "Time", "Tissue"))

pfos_obs <- pfos_obs %>%
  mutate(uM = as.numeric(trimws(uM)))  


# Plot for Time = 28 days
plot_28 <- ggplot() +
  geom_point(data = predictions %>% filter(Time == 28),
             aes(x = Dose, y = Predicted_Conc_uM, color = factor(Dose)),
             shape = 17, size = 4, alpha = 0.8) +
  geom_point(data = pfos_obs %>% filter(Time == 28),
             aes(x = Dose, y = uM, color = factor(Dose)),
             shape = 16, size = 2, alpha = 0.6) +
  facet_wrap(~ Tissue, scales = "free_y") +
  labs(
    title = "Predicted vs Observed PFOS Concentrations at 28 Days",
    x = "Dose (mg/kg)",
    y = "PFOS Concentration (µM)",
    color = "Dose (mg/kg)"
  ) +
  theme_minimal()

# Plot for Time = 56 days
plot_56 <- ggplot() +
  geom_point(data = predictions %>% filter(Time == 56),
             aes(x = Dose, y = Predicted_Conc_uM, color = factor(Dose)),
             shape = 17, size = 4, alpha = 0.8) +
  geom_point(data = pfos_obs %>% filter(Time == 56),
             aes(x = Dose, y = uM, color = factor(Dose)),
             shape = 16, size = 2, alpha = 0.6) +
  facet_wrap(~ Tissue, scales = "free_y") +
  labs(
    title = "Predicted vs Observed PFOS Concentrations PBTK",
    x = "Dose (mg/kg)",
    y = "PFOS Concentration (µM)",
    color = "Dose (mg/kg)"
  ) +
  theme_minimal()

print(plot_28)
print(plot_56)
```
###PFOA Plasma PBTK solve_pbtk (class.exclude =F)
```{r}
pfoa_obs <- pfas_obs_all %>%
  filter(PFAS_type == "PFOA")

dose_vec <- unique(pfoa_obs$Dose)
time_vec <- unique(pfoa_obs$Time)
tissues_all <- c("Plasma", "Liver", "Kidney", "Lung", "Fat", "Gut", "Bone", "Skin", "Muscle")

# Function to map tissue names to PBTK model column names
tissue_to_col <- function(tissue) {
  switch(tissue,
         Plasma = "Cplasma",
         Liver = "Cliver",
         Kidney = "Ckidney",
         Lung = "Clung",
         Fat = "Cfat",
         Gut = "Cgut",
         Bone = "Cbone",
         Skin = "Cskin",
         Muscle = "Cmuscle",
         stop(paste("Tissue not supported:", tissue)))
}

# Run model and get predictions
predictions <- map_df(dose_vec, function(dose) {
  out <- solve_pbtk(chem.cas = "335-67-1", 
                    days = max(time_vec), 
                    class.exclude = FALSE,
                    doses.per.day = 1,
                    daily.dose = dose,
                    output.units = "uM")

  map_df(tissues_all, function(tiss) {
    col_name <- tissue_to_col(tiss)
    
    if (!(col_name %in% colnames(out))) return(NULL)
    
    pred <- approx(x = out[, "time"], y = out[, col_name], xout = time_vec, rule = 2)
    
    data.frame(
      Dose = dose,
      Time = pred$x,
      Tissue = tiss,
      Predicted_Conc_uM = pred$y
    )
  })
})

# Join model predictions with observed data 
comparison <- pfoa_obs %>%
  left_join(predictions, by = c("Dose", "Time", "Tissue"))

# Separate predicted-only data for tissues without observations
model_only <- predictions %>%
  anti_join(pfoa_obs, by = c("Dose", "Time", "Tissue"))

pfoa_obs <- pfoa_obs %>%
  mutate(uM = as.numeric(trimws(uM)))  


# Plot for Time = 28 days
plot_28 <- ggplot() +
  geom_point(data = predictions %>% filter(Time == 28),
             aes(x = Dose, y = Predicted_Conc_uM, color = factor(Dose)),
             shape = 17, size = 4, alpha = 0.8) +
  geom_point(data = pfoa_obs %>% filter(Time == 28),
             aes(x = Dose, y = uM, color = factor(Dose)),
             shape = 16, size = 2, alpha = 0.6) +
  facet_wrap(~ Tissue, scales = "free_y") +
  labs(
    title = "Predicted vs Observed PFOS Concentrations at 28 Days",
    x = "Dose (mg/kg)",
    y = "PFOS Concentration (µM)",
    color = "Dose (mg/kg)"
  ) +
  theme_minimal()

# Plot for Time = 56 days
plot_56 <- ggplot() +
  geom_point(data = predictions %>% filter(Time == 56),
             aes(x = Dose, y = Predicted_Conc_uM, color = factor(Dose)),
             shape = 17, size = 4, alpha = 0.8) +
  geom_point(data = pfoa_obs %>% filter(Time == 56),
             aes(x = Dose, y = uM, color = factor(Dose)),
             shape = 16, size = 2, alpha = 0.6) +
  facet_wrap(~ Tissue, scales = "free_y") +
  labs(
    title = "Predicted vs Observed PFOA Concentrations PBTK",
    x = "Dose (mg/kg)",
    y = "PFOA Concentration (µM)",
    color = "Dose (mg/kg)"
  ) +
  theme_minimal()

print(plot_28)
print(plot_56)
```

##PFOS Clearance sumclearancepfas model
```{r}
#Exports as L/h/kg BW
clearance_pred <-  calc_total_clearance(chem.cas = "1763-23-1",
                               species="Rat", # Mouse doesnt work!!!
                               model = "pfas1compartment",
                              physchem.exclude=FALSE,
                               suppress.messages=TRUE)


pfos_obs <- pfas_obs_all %>%
  filter(PFAS_type == "PFOS")

fecal_obs <- pfos_obs %>%
  filter(Tissue == "Feces") %>% 
  select(Dose, Time, mg_kg, Mouse.ID) %>%
  mutate(
    # fecal rate in ng/h/kg
    ng_kg_h = (mg_kg* 1e6) * (0.08 / 24)   # 0.08 kg/day/kg → /24 = kg/hour/kg
  ) %>%
  group_by(Dose, Time)   

plasma_obs <- pfos_obs %>%
  filter(Tissue == "Plasma") %>%
  select(Dose, Time, ng_L, Mouse.ID)

clearance_fecal <- fecal_obs %>%
  left_join(plasma_obs, by = "Mouse.ID") %>%
  mutate(
    CL_L_h_kg = ng_kg_h / ng_L
  )


ggplot() +
  geom_point(data = clearance_fecal,
             aes(x = Dose.x, y = CL_L_h_kg, color = factor(Dose.x)),
             shape = 17, size = 4, alpha = 0.8) +
  geom_hline(yintercept = clearance_pred, linetype = "dashed", color = "red") +
  facet_wrap(~ Time.x, scales = "free_y") +
  labs(
    title = "Predicted vs Observed PFOA Excretion",
    x = "Dose (mg/kg)",
    y = "L/h/kg BW",
    color = "Dose (mg/kg)"
  ) +
  theme_minimal()
```
##PFOA Clearance sumclearancepfas model
```{r}
#Exports as L/h/kg BW
clearance_pred <-  calc_total_clearance(chem.cas = "335-67-1",
                               species="Rat", # Mouse doesnt work
                               model = "pfas1compartment",
                              physchem.exclude=FALSE,
                               suppress.messages=TRUE)


pfoa_obs <- pfas_obs_all %>%
  filter(PFAS_type == "PFOA")

fecal_obs <- pfoa_obs %>%
  filter(Tissue == "Feces") %>% 
  select(Dose, Time, mg_kg, Mouse.ID) %>%
  mutate(
    # fecal rate in ng/h/kg
    ng_kg_h = (mg_kg* 1e6) * (0.08 / 24)   # 0.08 kg/day/kg → /24 = kg/hour/kg
  ) %>%
  group_by(Dose, Time)   

plasma_obs <- pfoa_obs %>%
  filter(Tissue == "Plasma") %>%
  select(Dose, Time, ng_L, Mouse.ID)

clearance_fecal <- fecal_obs %>%
  left_join(plasma_obs, by = "Mouse.ID") %>%
  mutate(
    CL_L_h_kg = ng_kg_h / ng_L
  )


ggplot() +
  geom_point(data = clearance_fecal,
             aes(x = Dose.x, y = CL_L_h_kg, color = factor(Dose.x)),
             shape = 17, size = 4, alpha = 0.8) +
  geom_hline(yintercept = clearance_pred, linetype = "dashed", color = "red") +
  facet_wrap(~ Time.x, scales = "free_y") +
  labs(
    title = "Predicted vs Observed PFOA Excretion",
    x = "Dose (mg/kg)",
    y = "L/h/kg BW",
    color = "Dose (mg/kg)"
  ) +
  theme_minimal()
```

#Human equvilant dose using httk 2.7.2
##PFOS Oral equiv
```{r}
pfos_obs <- pfas_obs_all %>%
  filter(PFAS_type == "PFOS") %>%
  mutate(uM = as.numeric(trimws(uM)))

#I am using averaged PFAS conc in the plasma per dose and time group
plasma_obs <- pfos_obs %>%
  filter(Tissue == "Plasma") %>%
  select(Dose, Time, uM)
plasma_obs_avg_uM <- plasma_obs %>%
  group_by(Dose, Time) %>%
  summarise(avg_uM = mean(uM, na.rm = TRUE))

dose_vec <- unique(plasma_obs_avg_uM$avg_uM)

oral_equiv_results <- plasma_obs_avg_uM %>%
  rowwise() %>%
  mutate(
    # Get human PFOS PK parameters (1-compartment PFAS model)
    pars = list(parameterize_pfas1comp(
      chem.cas = "1763-23-1",
      species = "Human",
      dosingadj = "Oral",
      suppress.messages = TRUE
    )),
    # FAKE values
    pars = list({pars$Clint <- 1; pars$Funbound.plasma <- 1; pars}),
    # Calculate human oral equivalent dose
    oral_equiv_mgkgd = calc_mc_oral_equiv(
      species = "Human",
      chem.cas = "1763-23-1",
      conc = avg_uM,
      model = "pfas1compartment",
      input.units = "uM",
      output.units = "mgpkgpday",
      samples = 2000,
      parameters = pars
    )
  ) %>%
  ungroup() %>%
  select(Dose, Time, avg_uM, oral_equiv_mgkgd)


oral_equiv_results

ggplot() +
  geom_point(data = oral_equiv_results,
             aes(x = Dose, y = oral_equiv_mgkgd, color = factor(Dose)),
             shape = 17, size = 4, alpha = 0.8) +

  facet_wrap(~Time)+
  labs(
    title = "Predicted vs Observed PFOS Excretion",
    x = "Dose (mg/kg/day)",
    y = "mg/lg/day",
    color = "Dose (mg/kg/day)"
  ) +
  theme_minimal()
```


##PFOA Oral equiv
```{r}
pfoa_obs <- pfas_obs_all %>%
  filter(PFAS_type == "PFOA") %>%
  mutate(uM = as.numeric(trimws(uM)))

#I am using averaged PFAS conc in the plasma per dose and time group
plasma_obs <- pfoa_obs %>%
  filter(Tissue == "Plasma") %>%
  select(Dose, Time, uM)
plasma_obs_avg_uM <- plasma_obs %>%
  group_by(Dose, Time) %>%
  summarise(avg_uM = mean(uM, na.rm = TRUE))

dose_vec <- unique(plasma_obs_avg_uM$avg_uM)

oral_equiv_results <- plasma_obs_avg_uM %>%
  rowwise() %>%
  mutate(
    # Get human PFOA PK parameters (1-compartment PFAS model)
    pars = list(parameterize_pfas1comp(
      chem.cas = "335-67-1",
      species = "Human",
      dosingadj = "Oral",
      suppress.messages = TRUE
    )),
    # FAKE values
    pars = list({pars$Clint <- 1; pars$Funbound.plasma <- 1; pars}),
    # Calculate human oral equivalent dose
    oral_equiv_mgkgd = calc_mc_oral_equiv(
      species = "Human",
      chem.cas = "1763-23-1",
      conc = avg_uM,
      model = "pfas1compartment",
      input.units = "uM",
      output.units = "mgpkgpday",
      samples = 2000,
      parameters = pars
    )
  ) %>%
  ungroup() %>%
  select(Dose, Time, avg_uM, oral_equiv_mgkgd)


oral_equiv_results

ggplot() +
  geom_point(data = oral_equiv_results,
             aes(x = Dose, y = oral_equiv_mgkgd, color = factor(Dose)),
             shape = 17, size = 4, alpha = 0.8) +

  facet_wrap(~Time)+
  labs(
    title = "Predicted vs Observed PFOA Excretion",
    x = "Dose (mg/kg/day)",
    y = "mg/lg/day",
    color = "Dose (mg/kg/day)"
  ) +
  theme_minimal()
```

##Calc CSS equivilant
```{r}
##PFOS
pars <- parameterize_pfas1comp(
    chem.cas = "1763-23-1",
    species = "Human",
    dosingadj = "Oral",
    suppress.messages = TRUE,
  )

##FAKE VALUES
pars$Clint <-1
pars$Funbound.plasma <-1

css_pfos <- calc_mc_css(
  species = "Human",
  chem.cas = "1763-23-1",
  model = "pfas1compartment",
  parameters = pars,
  samples = 2000,
)

##Returns in Mg/L
css_pfos

##PFOA
pars <- parameterize_pfas1comp(
    chem.cas = "335-67-1",
    species = "Human",
    dosingadj = "Oral",
    suppress.messages = TRUE,
  )

##FAKE VALUES
pars$Clint <-1
pars$Funbound.plasma <-1

css_pfoa <- calc_mc_css(
  species = "Human",
  chem.cas = "335-67-1",
  model = "pfas1compartment",
  parameters = pars,
  samples = 2000,
)

##Returns in Mg/L
css_pfoa

plasma_obs_pfos <- pfos_obs %>%
  filter(Tissue == "Plasma") %>%
  select(Dose, Time, mg_L)%>%
  mutate(Chemical = "PFOS")

plasma_obs_pfoa <- pfos_obs %>%
  filter(Tissue == "Plasma") %>%
  select(Dose, Time, mg_L)%>%
  mutate(Chemical = "PFOA")
plasma <- rbind(plasma_obs_pfos , plasma_obs_pfoa)

ggplot() +
  geom_point(data = plasma,
             aes(x = Dose, y = mg_L, color = factor(Dose), shape = Chemical),
             shape = 17, size = 4, alpha = 0.8) +
  geom_hline(yintercept = css_pfoa, linetype = "dashed", color = "red") +
  geom_hline(yintercept = css_pfos, linetype = "dashed", color = "blue") +
  facet_wrap(~ Time, scales = "free_y") +
  labs(
    title = "Predicted vs Observed PFOA Excretion",
    x = "Dose (mg/kg)",
    y = "mg/L",
    color = "Dose (mg/kg)"
  ) +
  theme_minimal()
```


#Genra
##Inital plot of 5k chemicals
```{r}
#Load in analog info
RA_pfoa <-read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Desktop/PFAS PBTK/genra_20251208_PFOA.csv")
RA_pfos <-read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Desktop/PFAS PBTK/genra_20251210_PFOS.csv")

RA_pfoa <- RA_pfoa %>%
  mutate(Chemical = "PFOA")


RA_pfos <- RA_pfos %>%
  mutate(Chemical = "PFOS")


genra_combined<- rbind(RA_pfoa, RA_pfos) %>%
  drop_na(similarity) 


ggplot() +
  geom_point(data = genra_combined %>% 
                filter(Chemical =="PFOS"),
             aes(x = fct_reorder(dsstox_sid, similarity, .desc = TRUE), y = similarity, color = similarity), size = 1, alpha = 0.8) +
  facet_wrap(~ Chemical, scales = "free_y") +
      scale_color_viridis(option = "plasma", direction = -1) +
  labs(
    title = "NULL",
    x = "NULL",
    y = "Similarity",
    color = "Carbon lenght"
  ) +
    geom_hline(yintercept = 0.8, linetype = "dashed", color = "red") +
  ylim(0, 1) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # angle long names
    strip.text = element_text(size = 10)                # facet label size
  )

ggplot() +
  geom_point(data = genra_combined %>% 
                filter(Chemical =="PFOA"),
             aes(x = fct_reorder(dsstox_sid, similarity, .desc = TRUE), y = similarity, color = similarity),
       size = 1, alpha = 0.8) +
  facet_wrap(~ Chemical, scales = "free_y") +
      scale_color_viridis(option = "plasma", direction = -1) +
  labs(
    title = "NULL",
    x = "NULL",
    y = "Similarity",
    color = "Carbon lenght"
  ) +
    geom_hline(yintercept = 0.8, linetype = "dashed", color = "red") +
  ylim(0, 1) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # angle long names
    strip.text = element_text(size = 10)                # facet label size
  )

```

## PFOA TSNE
```{r}
#Subset Genra
genra_combined_pfoa <- genra_combined %>%
  filter(
    Chemical == "PFOA"
  )               

library(Rtsne)
set.seed(123)  # reproducibility

sim <- genra_combined_pfoa$smiles
dist_matrix <- as.dist(1 - sim)
tsne_out <- Rtsne(dist_matrix, dims = 2, perplexity = 10, verbose = TRUE)

tsne_df <- genra_combined_pfoa %>%
  mutate(tSNE1 = tsne_out$Y[,1],
         tSNE2 = tsne_out$Y[,2])


ggplot(tsne_df, aes(x = tSNE1, y = tSNE2, label = dsstox_sid, color = similarity)) +
    geom_point(size = 2) +
  #geom_text(vjust = -0.5, size = 0) +
  theme_minimal() +
  labs(title = "t-SNE of GENRA Chemicals (binary features)")
```
##PFOS TSNE
```{r}
genra_combined_pfos <- genra_combined %>%
  filter(
    Chemical == "PFOS"
  )

library(Rtsne)
set.seed(123)  # reproducibility

sim <- genra_combined_pfos$similarity
dist_matrix <- as.dist(1 - sim)
tsne_out_pfos <- Rtsne(dist_matrix, dims = 2, perplexity = 10, verbose = TRUE)

tsne_df_pfos <- genra_combined_pfos %>%
  mutate(tSNE1 = tsne_out_pfos$Y[,1],
         tSNE2 = tsne_out_pfos$Y[,2])


ggplot(tsne_df_pfos, aes(x = tSNE1, y = tSNE2, label = dsstox_sid, color = similarity)) +
    geom_point(size = 2) +
  #geom_text(vjust = -0.5, size = 0) +
  theme_minimal() +
  labs(title = "t-SNE of GENRA Chemicals (binary features)")
```

##EPA
```{r}
#Load in EPA info to get molecular formula
EPA_pfaslist <- read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Desktop/PFAS PBTK/Chemical List PFASSTRUCT-2025-12-08.csv")

EPA_pfaslist$dsstox_sid <- sub(".*/", "", EPA_pfaslist$DTXSID)
genra_combined<- rbind(RA_pfoa, RA_pfos) %>%
  drop_na(similarity) 
genra_combined <- genra_combined %>%
  left_join(EPA_pfaslist %>% select(dsstox_sid, MOLECULAR.FORMULA),
            by = "dsstox_sid") %>%
  filter(
    similarity > 0.8)

###grouping 
genra_class <- genra_combined %>%
  mutate(
    # Extract numbers for each atom (if missing, set to 0)
    C_total = as.numeric(str_extract(MOLECULAR.FORMULA, "(?<=C)\\d+")),
    O_total = as.numeric(str_extract(MOLECULAR.FORMULA, "(?<=O)\\d+")),
    S_total = as.numeric(str_extract(MOLECULAR.FORMULA, "(?<=S)\\d+"))
  ) %>%
  mutate(
    C_total = ifelse(is.na(C_total), 0, C_total),
    O_total = ifelse(is.na(O_total), 0, O_total),
    S_total = ifelse(is.na(S_total), 0, S_total)
  )
genra_class <- genra_class %>%
  mutate(
    PFAS_chain_length = case_when(
      str_detect(MOLECULAR.FORMULA, "C\\d+O2") ~ C_total - 1,   # COOH present
      str_detect(MOLECULAR.FORMULA, "SO3") ~ C_total - 1,       # sulfonic acid
      TRUE ~ C_total
    )
  )
# Step 2: Categorize PFAS
genra_class <- genra_class %>%
  mutate(
    PFAS_category = case_when(
      str_detect(MOLECULAR.FORMULA, "Cl") ~ "Chlorinated PFAS",
      str_detect(MOLECULAR.FORMULA, "S\\(=O\\)\\(=O\\)C|O3S") ~ "PFSA",  # matches sulfonate groups
      str_detect(MOLECULAR.FORMULA, "C\\(=O\\)O|O2") ~ "PFCA",           # matches carboxylate groups
      TRUE ~ "Other PFAS"
    )
  )
#Subset Genra
genra_combined_pfoa <- genra_class %>%
  filter(
    Chemical == "PFOA"
  )
genra_combined_pfos <- genra_class %>%
  filter(
    Chemical == "PFOS"
  )

ggplot() +
  geom_point(data = genra_combined_pfoa,
             aes(x = fct_reorder(name, similarity, .desc = TRUE), y = similarity, color = PFAS_chain_length, shape = PFAS_category), size = 4, alpha = 0.8) +
  facet_wrap(~ Chemical, scales = "free_y") +
      scale_color_viridis(option = "plasma", direction = -1) +
  labs(
    title = "NULL",
    x = "NULL",
    y = "Similarity",
    color = "Carbon lenght"
  ) +
  ylim(0.5, 1) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # angle long names
    strip.text = element_text(size = 10)                # facet label size
  )

ggplot() +
  geom_point(data = genra_combined_pfos,
               aes(x = fct_reorder(name, similarity, .desc = TRUE), y = similarity, color = PFAS_chain_length, shape = PFAS_category),
       size = 4, alpha = 0.8) +
  facet_wrap(~ Chemical, scales = "free_y") +
      scale_color_viridis(option = "plasma", direction = -1) +
  labs(
    title = "NULL",
    x = "NULL",
    y = "Similarity",
    color = "Carbon lenght"
  ) +
  ylim(0.5, 1) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # angle long names
    strip.text = element_text(size = 10)                # facet label size
  )


```
```{r}
pfas_class <- tibble(
  dsstox_sid = c(
  "DTXSID40892486",  # PFOA
  "DTXSID3031864",  # PFOS
  "DTXSID4059916",  # PFBA
  "DTXSID6062599",  # PFPeA
  "DTXSID3031862",  # PFHxA
  "DTXSID1037303",  # PFHpA
  "DTXSID8031863",  # PFNA
  "DTXSID3031860",  # PFDA
  "DTXSID8047553",  # PFUdA
  "DTXSID8031861",  # PFDoA
  "DTXSID90868151",  # PFTrDA
  "DTXSID3059921",  # PFTeDA
  "DTXSID60873015",  # PFBS
  "DTXSID8062600",  # PFPeS
  "DTXSID7040150",  # PFHxS
  "DTXSID8059920",  # PFHpS
  "DTXSID8071356",  # PFNS
  "DTXSID00873014",  # PFDS
  "DTXSID30891564",  # 4:2 FTS
  "DTXSID6067331",  # 6:2 FTS
  "DTXSID00192353",  # 8:2 FTS
  "DTXSID10624392",  # N-MeFOSAA
  "DTXSID60892504",  # N-EtFOSAA
  "DTXSID3038939"   # FOSA
  ),
PFAS_list = c(
"PFOA",
"PFOS",
"PFBA",
"PFPeA",
"PFHxA",
"PFHpA",
"PFNA",
"PFDA",
"PFUdA",
"PFDoA",
"PFTrDA",
"PFTeDA",
"PFBS",
"PFPeS",
"PFHxS",
"PFHpS",
"PFNS",
"PFDS",
"f4_2FTS",
"f6_2FTS",
"f8_2FTS",
"N_MeFOSAA",
"N_EtFOSAA",
"FOSA")
)
# Subset your main data
genra_subset <- genra_combined %>%
  left_join(pfas_class, by = "dsstox_sid") %>%
  filter(!is.na(PFAS_list))  

#Subset Genra
genra_combined_pfoa <- genra_subset %>%
  filter(
    Chemical == "PFOA"
  )
genra_combined_pfos <- genra_subset %>%
  filter(
    Chemical == "PFOS"
  )

ggplot() +
  geom_point(data = genra_combined_pfoa,
             aes(x = fct_reorder(name, similarity, .desc = TRUE), y = similarity, color = PFAS_list), size = 4, alpha = 0.8) +
  facet_wrap(~ Chemical, scales = "free_y") +
      scale_color_viridis_d(option = "plasma", direction = -1) +
  labs(
    title = "NULL",
    x = "NULL",
    y = "Similarity",
    color = "Carbon lenght"
  ) +
    geom_hline(yintercept = 0.8, linetype = "dashed", color = "red") +
  ylim(0, 1) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # angle long names
    strip.text = element_text(size = 10)                # facet label size
  )

ggplot() +
  geom_point(data = genra_combined_pfos,
             aes(x = fct_reorder(name, similarity, .desc = TRUE), y = similarity, color = PFAS_list),
       size = 4, alpha = 0.8) +
  facet_wrap(~ Chemical, scales = "free_y") +
      scale_color_viridis_d(option = "plasma", direction = -1) +
  labs(
    title = "NULL",
    x = "NULL",
    y = "Similarity",
    color = "Carbon lenght"
  ) +
    geom_hline(yintercept = 0.8, linetype = "dashed", color = "red") +
  ylim(0, 1) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # angle long names
    strip.text = element_text(size = 10)                # facet label size
  )
```


